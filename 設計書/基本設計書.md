# 📑 基本設計書

## 📌 1. システム概要

本システムは、スマートフォンのカメラで撮影した画像から文字を抽出し、指定されたGoogleスプレッドシートの特定セルに転記するWebアプリケーションです。OpenAI Vision APIを使用して画像からテキストを抽出し、Google Sheets APIを使用してスプレッドシートに転記します。

## 🏗️ 2. システム構成図

```
[ユーザー（ブラウザ）] 
      ↓ ↑
[Next.js フロントエンド] ← カメラアクセス
      ↓ ↑
[Next.js APIルート]
      ↓ ↑
[OpenAI Vision API] [Google Sheets API]
```

## 🔧 3. 機能仕様

### 3.1 画像撮影機能
- ブラウザからカメラにアクセスし、画像を撮影する
- 撮影した画像をプレビュー表示する
- 撮影をやり直す機能を提供する

### 3.2 テキスト抽出機能
- 撮影した画像をOpenAI Vision APIに送信する
- APIからの応答から必要なテキスト情報を抽出する
- 抽出したテキストをフロントエンドに表示する

### 3.3 スプレッドシート連携機能
- ユーザーが入力したスプレッドシートIDとセル範囲を検証する
- Google Sheets APIを使用して指定されたセルにテキストを転記する
- 転記結果をユーザーに通知する

## 📱 4. 画面設計

### 4.1 メイン画面

```
┌───────────────────────────────────────┐
│       テキスト抽出アプリケーション        │
├───────────────────────────────────────┤
│ スプレッドシートID:                     │
│ ┌─────────────────────────────────┐   │
│ │                                 │   │
│ └─────────────────────────────────┘   │
├───────────────────────────────────────┤
│ セル範囲:                              │
│ ┌─────────────────────────────────┐   │
│ │                                 │   │
│ └─────────────────────────────────┘   │
├───────────────────────────────────────┤
│                                       │
│                                       │
│            カメラビュー                │
│                                       │
│                                       │
├───────────────────────────────────────┤
│          [撮影する]  [リセット]        │
├───────────────────────────────────────┤
│ 抽出結果:                             │
│ ┌─────────────────────────────────┐   │
│ │                                 │   │
│ │                                 │   │
│ └─────────────────────────────────┘   │
├───────────────────────────────────────┤
│          [スプレッドシートに転記]       │
└───────────────────────────────────────┘
```

## 🔌 5. APIインターフェース設計

### 5.1 画像からテキスト抽出 API

- エンドポイント: `/api/extract-text`
- メソッド: POST
- リクエストボディ: 
  ```json
  {
    "image": "base64エンコードされた画像データ"
  }
  ```
- レスポンス:
  ```json
  {
    "success": true,
    "text": "抽出されたテキスト"
  }
  ```

### 5.2 スプレッドシート転記 API

- エンドポイント: `/api/update-spreadsheet`
- メソッド: POST
- リクエストボディ:
  ```json
  {
    "spreadsheetId": "スプレッドシートID",
    "range": "セル範囲",
    "text": "転記するテキスト"
  }
  ```
- レスポンス:
  ```json
  {
    "success": true,
    "message": "スプレッドシートに転記しました"
  }
  ```

## 💾 6. データモデル設計

このアプリケーションはステートフルなデータの永続化は行いませんが、以下の一時的なデータ構造を使用します：

```typescript
// 撮影画像データ
interface ImageData {
  dataUrl: string;  // Base64エンコードされた画像データ
}

// 抽出テキストデータ
interface ExtractedText {
  text: string;
  confidence?: number;
}

// スプレッドシート設定
interface SpreadsheetConfig {
  spreadsheetId: string;
  range: string;
}
```

## 🔒 7. セキュリティ設計

### 7.1 API認証
- Google Sheets APIへのアクセスはサーバーサイドのみで行い、APIキーをクライアントに公開しない
- OpenAI APIキーもサーバーサイドで管理する

### 7.2 データ検証
- ユーザー入力（スプレッドシートID、セル範囲）のバリデーションを実施
- APIリクエストのサイズ制限を設ける（画像データの上限を設定）

## ⚠️ 8. エラーハンドリング

以下のエラーケースに対応します：

1. カメラアクセス失敗時
2. 画像撮影失敗時
3. テキスト抽出API呼び出し失敗時
4. テキスト抽出結果が不明確または空の場合
5. スプレッドシートIDまたはセル範囲が不正な場合
6. スプレッドシートへの転記失敗時

各エラーに対して、ユーザーフレンドリーなエラーメッセージを表示し、可能な場合は回復手順を提案します。

## 📊 9. パフォーマンス考慮事項

- 画像データサイズの最適化（必要に応じてクライアント側で圧縮）
- APIリクエストのキャッシング
- ローディング状態の表示によるユーザー体験の向上

## 🧪 10. テスト計画

- 単体テスト：各APIエンドポイントの機能テスト
- 統合テスト：カメラ撮影からスプレッドシート転記までの一連のフローテスト
- ブラウザ互換性テスト：主要ブラウザでの動作確認
- レスポンシブデザインテスト：異なる画面サイズでの表示確認